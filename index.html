<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Demo Capture IP (Anonymized)</title>
</head>
<body>
  <p id="msg">Memproses...</p>

  <script type="module">
    const msg = document.getElementById('msg');

    // --- CONFIG: ganti ini ---
    const firebaseConfig = {
      apiKey: "AIzaSyDDImo9Vq1jqID6WDbGMXToexeIfNFOjpQ",
      authDomain: "iplo-50a21.firebaseapp.com",
      databaseURL: "https://console.firebase.google.com/u/9/project/iplo-50a21/database/iplo-50a21-default-rtdb/data/~2F",
      projectId: "iplo-50a21",
      appId: "1:488527718585:web:f1a35e256a0d3cf5021368"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-auth.js";
    import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    async function sha256hex(str){
      const buf = new TextEncoder().encode(str);
      const digest = await crypto.subtle.digest('SHA-256', buf);
      return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    async function getPublicIP(){
      try {
        const r = await fetch('https://api.ipify.org?format=json');
        if (!r.ok) throw new Error('ip service error');
        const j = await r.json();
        return j.ip;
      } catch(e){
        console.warn('Gagal ambil IP:', e);
        return null;
      }
    }

    async function writeVisit(obj){
      // tulis ke /visits
      const visitsRef = ref(db, 'visits');
      const newRef = push(visitsRef);
      await set(newRef, obj);
      return newRef.key;
    }

    (async function main(){
      try {
        msg.textContent = 'Signing in anonymously...';
        await signInAnonymously(auth); // optional but recommended if rules expect auth
      } catch(e){
        console.warn('Anon auth failed (continuing):', e);
      }

      msg.textContent = 'Mengambil IP publik...';
      const ip = await getPublicIP(); // bisa null
      const ua = navigator.userAgent || '';
      const path = location.pathname + location.search;
      const ts = Date.now();

      // Pilihan: anonymize/hashing IP sebelum simpan (disarankan)
      let ipToStore = null;
      if (ip) {
        ipToStore = await sha256hex(ip); // hash IP => tidak reversible
      }

      const payload = {
        ip: ipToStore,            // hashed ip (string) or null
        ip_present: !!ip,         // flag kalau kita berhasil ambil ip asli
        ua: ua,
        path: path,
        ts: ts
      };

      msg.textContent = 'Menyimpan ke Firebase Realtime DB...';
      try {
        await writeVisit(payload);
        msg.textContent = 'Sukses. Redirecting...';
      } catch(e){
        console.error('Write failed:', e);
        msg.textContent = 'Write gagal (check console). Redirecting anyway...';
      }

      // redirect ke google
      location.href = 'https://google.com';
    })();
  </script>
</body>
</html>
