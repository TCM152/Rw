<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Demo: Capture IP (with consent) & Redirect</title>
  <style>
    body { font-family: system-ui, Arial; display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#111;color:#eee; }
    .card{width:320px;padding:24px;border-radius:12px;background:#171717;box-shadow:0 6px 24px rgba(0,0,0,.6);text-align:center}
    button{margin-top:16px;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
    #loader{margin-top:16px;display:none}
  </style>
</head>
<body>
  <div class="card">
    <h3>Demo: Proses singkat</h3>
    <p id="msg">Website akan melakukan proses singkat â€” menyimpan <em>hash</em> IP untuk tujuan analitik. Data disimpan hanya untuk demo.</p>
    <button id="start">Setuju & Lanjut</button>
    <div id="loader">Memproses... (<span id="count">0</span>)</div>
  </div>

  <script type="module">
    // --- Ganti dengan Firebase config project mu ---
    const firebaseConfig = {
  apiKey: "AIzaSyDTEIm3Obhy6vuhJ1d9FpuGurtQzyJizAA",
  authDomain: "text-20c82.firebaseapp.com",
  databaseURL: "https://text-20c82-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "text-20c82",
  storageBucket: "text-20c82.firebasestorage.app",
  messagingSenderId: "762193914837",
  appId: "1:762193914837:web:14fcc9107fde4bbbcfeb5c",
  measurementId: "G-ZLSQZ0B383"
};

    // import modular Firebase (Realtime DB + Auth)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-auth.js";
    import { getDatabase, ref, push, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const startBtn = document.getElementById('start');
    const loader = document.getElementById('loader');
    const msg = document.getElementById('msg');
    const countEl = document.getElementById('count');

    function showLoader() { loader.style.display = 'block'; startBtn.style.display='none'; }
    function hideLoader() { loader.style.display = 'none'; startBtn.style.display='inline-block'; }

    async function sha256hex(str) {
      const buf = new TextEncoder().encode(str);
      const digest = await crypto.subtle.digest('SHA-256', buf);
      return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    async function getPublicIP() {
      try {
        const r = await fetch('https://api.ipify.org?format=json');
        if (!r.ok) throw new Error('ip service non-200');
        const j = await r.json();
        return j.ip;
      } catch (e) {
        console.warn('Gagal ambil IP:', e);
        return null;
      }
    }

    async function writeVisit(data) {
      // tulis ke path /visits/ (Realtime DB)
      const visitsRef = ref(db, 'visits');
      // push() create new childkey
      const newRef = push(visitsRef);
      await set(newRef, data);
      return newRef.key;
    }

    startBtn.addEventListener('click', async () => {
      // user has given consent by clicking
      showLoader();
      msg.textContent = 'Melakukan sign-in anonim ke Firebase...';

      try {
        await signInAnonymously(auth);
      } catch (e) {
        console.warn('Anon sign-in gagal, lanjut tetap mencoba (cek rules):', e);
      }

      msg.textContent = 'Mengambil IP publik (jika tersedia)...';
      let ip = await getPublicIP();
      msg.textContent = 'Menyiapkan data (anonimisasi)...';
      let ipHash = ip ? await sha256hex(ip) : null;

      // build payload
      const payload = {
        ip_hash: ipHash,           // hashed IP (atau null)
        ip_present: !!ip,
        ua: navigator.userAgent || '',
        path: location.pathname + location.search,
        ts: Date.now(),            // client timestamp (server ts not available in simple RTDB push)
        uid: auth.currentUser ? auth.currentUser.uid : null
      };

      // small progress counter (just visual)
      for (let i=1;i<=3;i++){ countEl.textContent = i; await new Promise(r=>setTimeout(r,450)); }

      msg.textContent = 'Menyimpan data (hash) ke database...';
      try {
        const key = await writeVisit(payload);
        msg.textContent = 'Sukses. Mengalihkan ke Instagram...';
      } catch (e) {
        console.error('Gagal menulis DB:', e);
        msg.textContent = 'Gagal simpan (cek console). Tetap dialihkan...';
      }

      // delay kecil supaya seperti "proses", lalu redirect
      await new Promise(r=>setTimeout(r,800));
      location.href = 'https://instagram.com';
    });
  </script>
</body>
</html>
